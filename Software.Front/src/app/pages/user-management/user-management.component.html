<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0 text-dark">Gerenciamento de Usuários</h1>
          <p class="text-muted mb-0">Gerencie todos os usuários do sistema</p>
        </div>
        <button class="btn btn-primary" (click)="showCreateForm()" [disabled]="loading">
          <i class="fas fa-plus me-2"></i>
          Novo Usuário
        </button>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text">
          <i class="fas fa-search"></i>
        </span>
        <input type="text" class="form-control" placeholder="Buscar por nome, email ou CPF..." [(ngModel)]="searchTerm"
          (input)="onSearchChange()">
      </div>
    </div>
    <div class="col-md-3">
      <select class="form-select" [(ngModel)]="selectedRole" (change)="onRoleChange()">
        <option value="0">Todos os tipos</option>
        <option value="1">Administradores</option>
        <option value="2">Médicos</option>
        <option value="3">Pacientes</option>
      </select>
    </div>
    <div class="col-md-3">
      <button class="btn btn-outline-secondary w-100" (click)="loadUsers()" [disabled]="loading">
        <i class="fas fa-sync-alt me-2"></i>
        Atualizar
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-3 text-muted">Carregando usuários...</p>
  </div>

  <!-- Users Table -->
  <div *ngIf="!loading" class="card">
    <div class="card-body p-0">
      <app-table [action]="action" [columns]="columns" (pageChange)="onSearch()" [pagedList]="pagedList"></app-table>
    </div>
  </div>

  <!-- User Form Modal -->
  <div *ngIf="showForm" class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            {{ editingUser ? 'Editar Usuário' : 'Novo Usuário' }}
          </h5>
          <button type="button" class="btn-close" (click)="hideForm()" [disabled]="loading">
          </button>
        </div>

        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
          <div class="modal-body">
            <div class="row">
              <!-- Nome -->
              <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Nome *</label>
                <input type="text" class="form-control" id="name" formControlName="name" placeholder="Nome do usuário"
                  [class.is-invalid]="userForm.get('name')?.invalid && userForm.get('name')?.touched">
                <div class="invalid-feedback" *ngIf="userForm.get('name')?.invalid && userForm.get('name')?.touched">
                  <span *ngIf="userForm.get('name')?.errors?.['required']">Nome é obrigatório</span>
                  <span *ngIf="userForm.get('name')?.errors?.['minlength']">Nome deve ter pelo menos 2 caracteres</span>
                </div>
              </div>

              <!-- Sobrenome -->
              <div class="col-md-6 mb-3">
                <label for="lastName" class="form-label">Sobrenome *</label>
                <input type="text" class="form-control" id="lastName" formControlName="lastName"
                  placeholder="Sobrenome do usuário"
                  [class.is-invalid]="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                <div class="invalid-feedback"
                  *ngIf="userForm.get('lastName')?.invalid && userForm.get('lastName')?.touched">
                  <span *ngIf="userForm.get('lastName')?.errors?.['required']">Sobrenome é obrigatório</span>
                  <span *ngIf="userForm.get('lastName')?.errors?.['minlength']">Sobrenome deve ter pelo menos 2
                    caracteres</span>
                </div>
              </div>
            </div>

            <!-- Username -->
            <div class="mb-3">
              <label for="username" class="form-label">Nome de Usuário *</label>
              <input type="text" class="form-control" id="username" formControlName="username" placeholder="nomeusuario"
                [class.is-invalid]="userForm.get('username')?.invalid && userForm.get('username')?.touched">
              <div class="invalid-feedback"
                *ngIf="userForm.get('username')?.invalid && userForm.get('username')?.touched">
                <span *ngIf="userForm.get('username')?.errors?.['required']">Nome de usuário é obrigatório</span>
                <span *ngIf="userForm.get('username')?.errors?.['minlength']">Nome de usuário deve ter pelo menos 3
                  caracteres</span>
              </div>
            </div>

            <!-- Email -->
            <div class="mb-3">
              <label for="email" class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" formControlName="email"
                placeholder="usuario@exemplo.com"
                [class.is-invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched">
              <div class="invalid-feedback" *ngIf="userForm.get('email')?.invalid && userForm.get('email')?.touched">
                <span *ngIf="userForm.get('email')?.errors?.['required']">Email é obrigatório</span>
                <span *ngIf="userForm.get('email')?.errors?.['email']">Email inválido</span>
              </div>
            </div>

            <!-- Senha -->
            <div class="mb-3">
              <label for="password" class="form-label">
                Senha {{ editingUser ? '(deixe em branco para manter a atual)' : '*' }}
              </label>
              <input type="password" class="form-control" id="password" formControlName="password"
                placeholder="••••••••"
                [class.is-invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched">
              <div class="invalid-feedback"
                *ngIf="userForm.get('password')?.invalid && userForm.get('password')?.touched">
                <span *ngIf="userForm.get('password')?.errors?.['required']">Senha é obrigatória</span>
                <span *ngIf="userForm.get('password')?.errors?.['minlength']">Senha deve ter pelo menos 6
                  caracteres</span>
              </div>
            </div>

            <!-- CPF -->
            <div class="mb-3">
              <label for="cpf" class="form-label">CPF *</label>
              <input type="text" class="form-control" id="cpf" formControlName="cpf" placeholder="000.000.000-00"
                (input)="formatCpf($event)" maxlength="14"
                [class.is-invalid]="userForm.get('cpf')?.invalid && userForm.get('cpf')?.touched">
              <div class="invalid-feedback" *ngIf="userForm.get('cpf')?.invalid && userForm.get('cpf')?.touched">
                <span *ngIf="userForm.get('cpf')?.errors?.['required']">CPF é obrigatório</span>
                <span *ngIf="userForm.get('cpf')?.errors?.['pattern']">CPF deve estar no formato 000.000.000-00</span>
              </div>
            </div>

            <!-- Tipo de Usuário -->
            <div class="mb-3">
              <label for="role" class="form-label">Tipo de Usuário *</label>
              <select class="form-select" id="role" formControlName="role"
                [class.is-invalid]="userForm.get('role')?.invalid && userForm.get('role')?.touched">
                <option value="3">Paciente</option>
                <option value="2">Médico</option>
                <option value="1">Administrador</option>
              </select>
              <div class="invalid-feedback" *ngIf="userForm.get('role')?.invalid && userForm.get('role')?.touched">
                Tipo de usuário é obrigatório
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="hideForm()" [disabled]="loading">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              {{ editingUser ? 'Atualizar' : 'Criar' }} Usuário
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>